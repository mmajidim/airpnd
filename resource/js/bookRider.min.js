function getLifts(){if($.session.get("dateFindRider")){$("#bookRideContainer").removeClass("hide");$("#errorContainer").addClass("hide");var e={action:GET_LIFTS,rideId:JSON.stringify($.session.get("rideId")),startType:JSON.stringify($.session.get("addressType")),location:JSON.stringify($.session.get("locationFindRider")),address:JSON.stringify($.session.get("addressFindRider")),date:JSON.stringify($.session.get("dateFindRider")),time:JSON.stringify($.getDateTime.time($.session.get("timeFindRider"),true)),seats:JSON.stringify($.session.get("seatsFindRider")),bags:JSON.stringify($.session.get("bagsFindRider")),bagSize:JSON.stringify($.session.get("bagSizeFindRider")),smoker:JSON.stringify($.session.get("smokerFindRider"))};$.ajax({type:"POST",url:CUSTOM_API_URL,data:e,dataType:"json",headers:HEADER,async:false,error:function(e){showAlertBox("Error",ERROR_MSG)},success:function(e){$.session.set("ridersData",JSON.stringify(e));loadRidesContainer()}})}else{var t='<table class="table table-bordered"><tr>';t+="<th>First Name</th><th>Last Name</th><th>Pick Up</th>";t+="<th>Drop Off</th><th>Via</th><th>Smoker</th>";t+="<th>Within</th><th>Contribution</th></tr>";t+='<tr><td colspan="99"><center><b>No Records Found !';t+="</b></center></td></tr></table>";$("#rideContainer").append(t)}}function loadRidesContainer(){loadMatchedRiders("maxMiles",1)}function loadMatchedRiders(e,t){$("#rideContainer").empty();$("#rideContainer").fadeOut("slow");var n="";var r=JSON.parse($.session.get("ridersData"));if(r.retCode&&r.lifts.length>0){r=sortByKey(r.lifts,e,t);var i=r[0].startType==AIRPORT_START?"Airport":"Address";var s=r[0].startType==ADDRESS_START?"Airport":"Address";n+='<table class="table table-bordered"><tr>';n+="<th>First Name</th><th>Last Name</th><th>"+i+"</th>";n+="<th>"+s+"</th><th>Smoker</th>";n+="<th>Seats</th>";n+="<th>Within</th>";n+="<th>Contribution</th>";n+="<th>Datetime</th><th>&nbsp;</th></tr>";$.each(r,function(e,t){var r=t.smoker?"YES":"NO";var i=$.getDateTime.datePickerDateTime(t.datetime);var s=$.session.get("seatsFindRider")>=t.seats?t.seats:$.session.get("seatsFindRider");n+="<tr><td>"+t.firstName+"</td>";n+="<td>"+t.lastName.substring(0,1)+"..."+"</td>";n+="<td>"+t.start+"</td>";n+="<td>"+t.to+"</td>";n+="<td>"+r+"</td>";n+="<td>"+t.seats+"</td>";n+="<td>"+t.maxMiles+" Miles</td>";n+="<td>"+t.contribution.toFixed(2)+" $</td>";n+="<td>"+i+" </td>";n+='<td><a href="#" liftId="'+t.lId+'" customerId="'+t.customerId+'" rideId="';n+='" class="select btn btn-default" seats="';n+=s+'"> ';n+="Request </a></td></tr>"});n+="</table>"}else{$("#filterBy").hide();$("#sortBy").hide();n+='<table class="table table-bordered"><tr>';n+="<th>First Name</th><th>Last Name</th><th>Pick Up</th>";n+="<th>Drop Off</th><th>Smoker</th>";n+="<th>Within</th><th>Contribution</th></tr>";n+='<tr><td colspan="99"><center>';n+="No Records Found !</center></td></tr></table>"}$("#rideContainer").append(n);$("#rideContainer").fadeIn("slow");setTimeout(function(){getPopUp(".select","#popUpContainer","right")},100)}function loadOtherFeatures(e){$("#priceDetailsPopUp").empty();var t=getEntityFeaturesById(e);var n='<div class="container-fluid"><div class="row-fluid">';n+='<div class="row padLeft"><div class="row-fluid">';n+='<div class="span10"><div><b>Car Details</b></div>';n+='</div><div class="span2"><button  class="close popup"';n+='type="button">Ã—</button></div></div>';n+='<div class="row-fluid"><div class="row-fluid ">';n+="<ul><h4>Features</h4>";if(t.retCode&&t.features.length>0){t=t.features;$.each(t,function(e,t){if(e>5)return false;n+='<li class="priceList">'+t.name+" : "+t.description+"</li>"});n+="<li>&nbsp;</li>";n+="</ul></div></div></div></div></div>"}else{n+='<li class="priceList">No features forund !</li>'}$("#priceDetailsPopUp").append(n);getPopUp("#priceDetail","#priceDetailsPopUp","left")}function bookALift(e,t,n){var r=-1;var i={action:BOOK_A_LIFT,rideId:JSON.stringify(e),liftId:JSON.stringify(t),seats:JSON.stringify(n)};$.ajax({type:"POST",url:CUSTOM_API_URL,data:i,dataType:"json",headers:HEADER,async:false,error:function(e){showAlertBox("Error",ERROR_MSG)},success:function(e){r=e.retCode}});return r}function getLiftsByRide(e){var t={action:GET_A_RIDE,rideId:JSON.stringify(e)};$.ajax({type:"POST",url:CUSTOM_API_URL,data:t,dataType:"json",headers:HEADER,async:false,error:function(e){showAlertBox("Error",ERROR_MSG)},success:function(e){loadLifts(e)}})}function loadLifts(e){var t="";if(e.liftsStream.length>0){var n=e.liftsStream;$.each(n,function(e,n){var r=n.firstName+" "+n.lastName;var i=n.status==NEW_LIFT?"":"hide";t+='<table class="table table-bordered"><tr ';t+='class="confirmRideRow'+i+'">';t+='<td colspan="99" class="pull-left">';t+='<button type="button"';t+=' class="btn btn-success confirmRide"';t+=' liftId="'+n.liftId+'">Get My Ride';t+="</button></td></tr>";t+="<tr><td>Name</td><td>"+r+"</td></tr>";t+="<tr><td>Email Id</td><td>"+n.email+"</td></tr>";t+="<tr><td>Phone</td><td>"+n.phone+"</td></tr>";t+="<tr><td>Address</td><td>"+n.address+"</td></tr>";t+="<tr><td>Time</td><td>"+n.time+"</td></tr>";t+="<tr><td>Note</td><td >"+(n.time||"")+"</td>";t+="</tr></table>"})}else{t='<div><h2 class="greenLabel">No Lift is assigned with';t+=" this ride.</h2></div>"}$("#lifts").append(t);$("#liftsContainer").removeClass("hide");setTimeout(function(){$("#lifts").liquidSlider({autoHeight:false,mobileNavDefaultText:"Lifts",slideEaseFunction:"animate.css",slideEaseDuration:50,heightEaseDuration:50,animateIn:"bounceInDown",animateOut:"bounceInUP",preloader:false,responsive:true,mobileNavigation:true,swipe:true})},100)}function getRiderEmailBody(e,t,n){var r;var i='<a class="btnEmail" href="{0}';i+='confirmRide.php{1}">Click Here </a>';var s=String.format(i,SITE_URL,n);var r="<div><p><strong>Dear "+e+"</strong>,</p><br />";r+="<p>You have successfully book a ride .</p>";r+="<p>Please click on the link to confirm a ride.";r+="</p><p>"+s+"<br><br></p>";r+="<br /><p>Regards:-</p>";r+="<p>Airpnd Team.</p>";r+="<p><sub><i>This is a system generated";r+="&nbsp;mail. Please do not reply to it.";r+="</i><sub></p></div>";return r}function getDriverMailBody(e,t){var n="<div><p><strong>Dear "+e+"</strong>,</p><br />";n+="<p>You request has been sent to the rider .</p>";n+="<p><strong>Rider Details</strong></p>";n+='<table border="1px">';n+="<tr><td> Rider Name </td><td>"+t.name+"</td></tr>";n+="<tr><td> Rider Email </td><td>"+t.email+"</td></tr></table>";n+="<br /><p>Regards:-</p>";n+="<p>Airpnd Team.</p>";n+="<p><sub><i>This is a system generated";n+="&nbsp;mail. Please do not reply to it.";n+="</i><sub></p></div>";return n}function getMyRides(){var e=$("#myLiftsContainer").children().length==0;if(e){var t=sessionManager("getSession","customerId");var n=rideByCustomer(t);var r="";var i=n.lifts==null||n.lifts.length==1;if(n.retCode&&n.rides.length>0){var s=sortByKey(n.rides,"dt","0");$.each(s,function(e,t){var n=t.status!=2;var i=$.getDateTime.formatDate(t.dt);var s=$.getDateTime.formatDateTime(t.dt);r+='<div><h2 class="title greenLabel">'+i+"</h2>";r+='<table class="table table-striped">';if(n){r+='<tr><td colspan="99">';r+='<a href="#" class="selectRide '+n+'"';r+=' rideId="'+t.id+'" date="'+t.dt+'"';r+=' customerId="'+t.customerId+'">';r+='<i class="icon-th"></i>';r+=" Select Ride</a></td></tr>"}r+='<tr><td>Date</td><td class="dateTime">'+s+"</td></tr>";r+='<tr><td>From</td><td class="start">'+t.start+"</td></tr>";r+='<tr><td>Via</td><td class="via">'+t.via+"</td></tr>";r+='<tr><td>To</td><td class="to">'+t.to+"</td></tr>";r+="<tr><td>Seats</td><td>"+t.seats+"</td></tr>";r+="<tr><td>Status</td><td>"+getStatusName(t.status)+"</td></tr>";r+='<tr><td>Note</td><td  class="textBreak">  '+(t.note||"-")+"</td></tr>";r+="</table></div>"})}else{r+='<div><h2 class="greenLabel">No ride is found</h2>';r+="</div>"}$("#myLiftsContainer").append(r)}$("#modalFade").removeClass("hide");$("#panelMyLift").removeClass("hide");if(e){$("#myLiftsContainer").contentSlider("My Rides",i,$.session.get("selectedTabBookRider"))}}function getStatusName(e){var t="";switch(parseInt(e)){case 0:t="New Ride";break;case 1:t="Pending";break;case 2:t="Full";break}return t}function doBookingProcess(e){var t=e.userInfoId||e;var n={action:GET_CUSTOMER_BY_ID,id:t};$.ajax({type:"POST",url:API_URL,data:n,dataType:"xml",headers:HEADER,async:false,error:function(e){showAlertBox("Error",ERROR_MSG)},success:function(e){customer=e}})}$(function(){getLifts();initializeModal("panelMyLift");$("#filterOrder").on("change",function(){loadMatchedRiders($("#filterPrice option:selected").val(),$("option:selected",this).val())});$("#filterPrice").on("change",function(){loadMatchedRiders($("option:selected",this).val(),$("#filterOrder option:selected").val())});$(document).on("click",".close",function(){$("#modalFade").addClass("hide");$("#panelMyLift").addClass("hide")});getPopUp(".select","#popUpContainer","right");$(document).on("click",".selectRide",function(e){$.session.set("rideId",$(this).attr("rideId"));$("#modalFade").addClass("hide");$("#panelMyLift").addClass("hide");$.session.set("hasRide",true);e.preventDefault()});$(document).on("click",".select",function(e){$.session.set("liftId",$(this).attr("liftId"));$.session.set("seats",$(this).attr("seats"));$.session.set("riderId",$(this).attr("customerId"));var t=sessionManager("getSession","customerId");if(t){if(!$.session.get("hasRide")){var n=rideByCustomer(t);getMyRides()}else{$(this).popover("show");$(".select").not(this).popover("hide")}}else{loadSignInModal()}return false});$(document).on("click",".closePopUp",function(e){$(this).closest(".popover").removeClass("in");return false});$(document).on("click","#sendSMS",function(e){$("#sendSmsLoader").removeClass("hide");$("#sendSMS").attr("disabled","disabled");window.setTimeout(function(){var e=getCustomerByCustomerId($.session.get("riderId"),true);var t=$("response returnVal phone1",e).text();t=t.split("-").join("");var n=$("response returnVal firstName",e).text();+" "+$("response returnVal lastName",e).text();var r=$("response returnVal email",e).text();var i=$.session.get("liftId")+";"+$.session.get("rideId")+";"+$.session.get("seats");var s=getLink(i);var o=$("#messageContent").val()+"\n"+" "+SITE_URL+"confirmRide.php"+s;var u=sendTextMessage(t,o);var a=getRiderEmailBody(n,r,s);var f=sendEmail(r,"Confirm a Ride ",a);var l=sessionManager("getSession","user");var c=getOwnerByOwnerId(l.userInfoId,true);var h=$("response firstName",c).text()+" "+$("response lastName",c).text();var p={name:n,email:r};var d=getDriverMailBody(h,p);f=sendEmail($("response email",c).text(),"Acknowledgment For Booking a Rider",d);if(u||f){u=bookALift($.session.get("rideId"),$.session.get("liftId"),$.session.get("seats"));u=pendingConfirmLift($.session.get("liftId"));if(u){$.session.clear("hasRide");$.session.clear("rideId");showAlertBox("Confirm Alert","A confirm lift link is sent to the rider number.",SITE_URL+"findRider.php");$("#sendSmsLoader").hide()}else{showAlertBox("Error",ERROR_MSG)}}return false},100)});$(document).on("click",".showLift",function(){var e=$(this).closest("table").children(".seats").html();$.session.set("rideId",$(this).attr("rideId"));$.session.set("seats",e);getLiftsByRide($(this).attr("rideId"))});$(document).on("click",".confirmRide",function(){$("#paymentModal").modal("show")})});$(window).on("load",function(){$("#filterOrder").select2();$("#filterPrice").select2();loadMatchedRiders($("#filterPrice option:selected").val(),$("option:selected","#filterOrder").val())});$(window).bind("beforeunload",function(){if($("#myLiftsContainer-nav-select").is(":visible")){var e=$("#myLiftsContainer-nav-select option:selected").val().split("tab")[1];$.session.set("selectedTabBookRider",e)}else{$("#myLiftsContainer-nav-ul li").each(function(e,t){if($("a",this).hasClass("current")){var n=$("a",this).attr("href").split("#")[1];$.session.set("selectedTabBookRider",n)}})}})