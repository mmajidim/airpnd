function loadRideByCustomer(){var e=sessionManager("getSession","customerId");if(e){var t=rideByCustomer(e);loadMyRides(t);var n=t.rides==null||t.rides.length==1||t.rides.length==0;$("#myRidesContainer").contentSlider("My Rides",n,$.session.get("selectedTabMyBooking"))}else{loadSignInModal()}}function loadMyRides(e){var t="";var n={};if(e.retCode&&e.rides.length>0){e=sortByKey(e.rides,"dt","0");$.each(e,function(e,r){var i=r.editable==1;var s=r.lifts.length>0?true:false;var o=!s&&r.status==NEW_RIDE;var u=r.bags==null?"NA":r.bags;var a=getBagSizeName(r.bagSize);var f=r.smoker==1?"YES":"NO";var l=r.note==null?"-":r.note;var c=$.getDateTime.formatDate(r.dt);var h=$.getDateTime.formatTime(r.dt);var p=r.startType==AIRPORT_START?"Airport":"Address";var d=r.startType==ADDRESS_START?"Airport":"Address";var v=r.via==null||r.via==""?"NA":r.via;n[r.id]=r;t+='<div><h2 class="title greenLabel">'+c+"</h2>";t+='<table class="table table-striped"><tbody>';t+='<tr class="tdHeader"><td  colspan=3><a href="#"';t+=' for="'+r.id+'"';t+=' class="showLift"><i class="icon-th"></i>&nbsp;';t+="Show Lift</a></td>";if(i){t+='<td class="pull-right" colspan=2>';t+='<a href="#" for="'+r.id+'" status="'+r.status+'"';t+=' entityId="'+r.entityId+'" ownerId="'+r.ownerId+'"';t+=' customerId="'+r.customerId+'"';t+=' class="editRide margin-right">';t+='<i class="icon-pencil"></i>&nbsp;Edit</a></td>'}if(o){t+='<td class="pull-right" colspan=2>';t+='<a href="#" for="'+r.id+'"';t+=' entityId="'+r.entityId+'"';t+=' class="deleteRide">';t+='<i class="icon-trash"></i>&nbsp;Delete</a></td>'}t+="</tr>";t+="<tr><td colspan=2>"+p+"</td><td colspan=2>";t+=r.start+"</td></tr><tr>";t+="<td colspan=2>Via</td><td colspan=2>"+v+"</td></tr>";t+="<tr><td colspan=2>"+d+"</td><td colspan=2>"+r.to+"</td></tr>";t+="<tr><td colspan=2>Date</td><td colspan=2>"+c+"</td></tr>";t+="<tr><td colspan=2>Time</td><td colspan=2>"+h+"</td></tr>";t+="<tr><td colspan=2>Available Seats</td>";t+="<td colspan=3>"+r.seats+"</td></tr>";t+="<tr><td colspan=2>Bags</td><td colspan=2>";t+=u+"</td></tr><tr><td colspan=2>";t+="Bag Size</td><td colspan=2>";t+=a+"</td></tr><tr><td colspan=2>";t+=" Miles</td><td colspan=2>";t+=r.maxMiles+"</td></tr><tr>";t+="<td colspan=2>Contribution</td>";t+="<td colspan=3>"+r.contribution+" $"+"</td></tr>";t+="<td colspan=2>Status</td>";t+="<td colspan=3>"+getRideStatusName(r.status);t+="</td></tr><tr><td colspan=2>Smoker</td>";t+="<td colspan=2>"+f+"</td>";t+="</tr><tr><td colspan=2>Note";t+='</td><td class="textBreak" colspan=2>  ';t+=l+"</td>";t+="</tr></tbody></table></div>"});$.session.set("liftData",JSON.stringify(n))}else{t='<div><h2 class="greenLabel">No ride is found.</h2></div>'}$("#myRidesContainer").append(t)}function updateRide(){var e=$("#editRidePriceRange").html().split("$")[1];var t=updateRidePrice($.session.get("entityId"),e);if(t.retCode){updateARide()}else{$("#editRideLoader").addClass("hide");$("#updateRide").removeAttr("disabled");showAlertBox("Error",ERROR_MSG)}moveTotop()}function updateARide(){var e=$("#startEditRideSelect").css("display")!="none"?$("option:selected","#editRideStartLocation").val():$("#editRideFromAddress").val();var t=$("#toEditRideInput").is(":visible")?$("#editRideToAddress").val():$("option:selected","#editRideToStartLocation").val();var n=$("#startEditRideSelect").css("display")!="none"?AIRPORT_START:ADDRESS_START;var r=$("#editRideDateTime").val();var i=$.getDateTime.time($("#editRideTime").val(),true);var s=$("#editRideRange").html().split(" ")[0];var o=$("#editRidePriceRange").html().split("$")[1];var u={id:$.session.get("rideId"),ownerId:$.session.get("ownerId"),entityId:$.session.get("entityId"),date:r,time:i,start:e,to:t,startType:n,via:$("#editRideViaLocation").val(),maxMiles:s,contribution:o,seats:$("#editRideSeat").val(),status:$.session.get("status"),smoker:$("#smoker").is(":checked"),bags:$("#editBags").val(),bagSize:$("#editRideBagSizeSelect option:selected").val(),note:$("#editRideNote").val()};var a={action:UPDATE_A_RIDE,ride:JSON.stringify(u)};$.ajax({type:"POST",url:CUSTOM_API_URL,data:a,dataType:"json",headers:HEADER,async:false,error:function(e){$("#editRideLoader").addClass("hide");$("#updateRide").removeAttr("disabled");showAlertBox("Error",ERROR_MSG)},success:function(e){$("#updateRide").removeAttr("disabled");$("#editRideLoader").addClass("hide");if(e.retCode){$("#editRideModal").modal("hide");showAlertBox("Update Alert","Your changes have been saved.",SITE_URL+"myBookings.php")}}})}function deleteRide(e){var t={action:DELETE_A_RIDE,rideId:e};$.ajax({type:"POST",url:CUSTOM_API_URL,data:t,dataType:"json",headers:HEADER,async:false,error:function(e){showAlertBox("Error",ERROR_MSG)},success:function(e){if(e.retCode){showAlertBox("Delete Alert","Your record has been deleted successfully.",SITE_URL+"myBookings.php")}}});moveTotop()}function loadLiftsAssigned(e){$("#liftAssignedContainer").empty();var t=e.lifts==null||e.lifts.length==1||e.lifts.length==0;t?$("#liftAssignedContainer-wrapper").addClass("noScroll"):$("#liftAssignedContainer-wrapper").removeClass("noScroll");var n="";if(e&&e.lifts.length>0){var r=e.lifts;$.each(r,function(e,t){var r=t.firstName+" "+t.lastName;var i=t.time?t.time:$.getDateTime.formatTime(t.dt);n+='<table class="table table-bordered">';n+="<tr><td>Name</td><td>"+r+"</td></tr>";n+="<tr><td>Email Id</td><td>"+t.email+"</td></tr>";n+="<tr><td>Phone</td><td>"+t.phone+"</td></tr>";n+="<tr><td>Drop-Off</td><td>"+(t.to||"-")+"</td></tr>";n+="<tr><td>Time</td><td>"+i+"</td></tr>";n+="<tr><td>Note</td><td >"+(t.note||"-")+"</td>";n+="</tr></table>"})}else{n='<div><h2 class="greenLabel">No Lift is assigned with';n+=" this ride.</h2></div>"}$("#liftAssignedContainer").append(n);$("#liftAssignedPanel").removeClass("hide");setTimeout(function(){$("#liftAssignedContainer").contentSlider("Assigned Lifts",t)},100)}function getCountribution(){airportName=$("#startEditRideSelect").css("display")!="none"?$("option:selected","#editRideStartLocation").val():$("option:selected","#editRideToStartLocation").val();driverAddress=$("#toEditRideInput").is(":visible")?$("#editRideToAddress").val():$("#editRideFromAddress").val();if(driverAddress.trim()!=""){var e=getPriceForRide(airportName,driverAddress,$("#editRideRange").text().split(" ")[0]);$("#editRidePriceSlider").slider("option","max",e<=1?0:e);$("#editRidePriceSlider").slider("option","disabled",false);var t=$("#editRidePriceSlider").slider("value")<=1?"":$("#editRidePriceSlider").slider("value");$("#editRidePriceRange").html("$"+t);$("#maxPrice").html(e<=1?0:e)}}function updateRidePrice(e,t){var n=getPrice(e);var r=n[0].id;var i=-1;var s=[[r,t,t]];var o={action:UPDATE_PRICE,entityId:e,type:FIXED_TYPE,priceList:JSON.stringify(s)};$.ajax({type:"POST",url:API_URL,data:o,dataType:"json",headers:HEADER,async:false,error:function(e){i=-1},success:function(e){i=e}});return i}function getRideStatusName(e){var t="";switch(e){case"0":t="Available";break;case"1":t="Pending";break;case"2":t="Full";break}return t}function loadRideInfo(e){var t=$.getDateTime.formatDate(e.dt);var n=$.getDateTime.formatTime(e.dt);var r=(new Date).getTime();var i=(new Date(e.dt)).getTime();if(i<r){n=$.getDateTime.formatTime(new Date)}$("#editRideForm").find("input").each(function(){if($(this).hasClass("error")){$(this).removeClass("error")}});$("#editRideDateTime").val(t);$("#editRideTime").val(n);$("#editRideDateTime").datePicker(t);$("#editRideTime").timePicker(n);$("#editRideViaLocation").val(e.via);$("#editRideSeat").select2("val",e.seats);$("#editRideNote").val(e.note);$("#editRideBagSize").val(e.bagSize);$("#editRideBagSizeSelect").select2("val",e.bagSize);$("#editBags").val(e.bags);if(e.startType==ADDRESS_START){if($("#editRideToAddress").hasClass("isShown")){$("#startEditRideSelect,#startEditRideInput,#toEditRideInput,#toEditRideSelect").toggleClass("hide");$("#startEditRideInput #editRideFromAddress,#toEditRideInput #editRideToAddress").toggleClass("ignore");$("#editRideStartLocation,#editRideFromAddress,#editRideToAddress,#editRideToStartLocation").toggleClass("isShown")}airportName=e.to;driverAddress=e.start;$("#editRideFromAddress").val(e.start);$("#editRideToStartLocation").select2("val",e.to);$("#startLabel").html("Address");$("#toLabel").html("Airport")}else if(e.startType==AIRPORT_START){if($("#editRideFromAddress").hasClass("isShown")){$("#startEditRideSelect,#startEditRideInput,#toEditRideInput,#toEditRideSelect").toggleClass("hide");$("#startEditRideInput #editRideFromAddress,#toEditRideInput #editRideToAddress").toggleClass("ignore");$("#editRideStartLocation,#editRideFromAddress,#editRideToAddress,#editRideToStartLocation").toggleClass("isShown")}airportName=e.start;driverAddress=e.to;$("#editRideStartLocation").select2("val",e.start);$("#editRideToAddress").val(e.to);$("#startLabel").html("Airport");$("#toLabel").html("Address")}var s=e.smoker==1?"checked":"";$("#smoker").prop("checked",s);$("#editRideLocation").getSlider("editRideRange"," Miles");$("#editRidePriceSlider").getSlider("editRidePriceRange",null,"$",.01);var o=getPriceForRide(airportName,driverAddress,$("#maxDistance").text());$("#editRidePriceSlider").slider("option","max",o);$("#editRidePriceSlider").slider("option","disabled",false);$("#editRidePriceRange").html(e.contribution);$("#editRidePriceSlider").slider("value",e.contribution);$("#editRideLocation").slider("value",e.maxMiles);$("#editRideRange").html($("#editRideLocation").slider("value")+" Miles");$("#editRidePriceRange").html("$"+e.contribution);$("#maxPrice").html(o);$.validator.addMethod("minStrict",function(e,t,n){var r=$("#editRideDateTime").val()+" "+$("#editRideTime").val();e=(new Date(r)).getTime();return e>n});$("#editRideTime").rules("add",{required:true,minStrict:(new Date).getTime(),messages:{required:"Please enter time",minStrict:jQuery.format("Time should  be greater than current time")}})}function deleteItem(e){var t=-1;var n={action:DELETE_ITEM,itemId:e};$.ajax({type:"POST",url:API_URL,data:n,dataType:"json",headers:HEADER,error:function(e){t=-1},success:function(e){t=e.retCode}});return t}$(function(){function r(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(e){var t=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);n.setBounds(new google.maps.LatLngBounds(t,t))})}}var e;var t;$(window).keydown(function(e){if(e.keyCode==13){e.preventDefault();return false}});var n;getLocation("editRideStartLocation",true);getLocation("editRideToStartLocation",true);$("#editRideBagSizeSelect").select2();$("#editRideSeat").select2();getSeats("editRideSeat");getBagTypes("editRideBagSizeSelect");$("#editRideToLocation").filterType("special");$("#editRideViaLocation").filterType("special");$("#editRideSeat").filterType("numeric");$("#editRideNote").filterType("special");initializeModal("editRideModal");$("#editRideLocation").on("slidestop",function(e,t){getCountribution()});loadRideByCustomer();$(".closeModal").on("click",function(){$("#editRideModal").modal("hide");$(".popover").remove()});n=new google.maps.places.Autocomplete(document.getElementById("editRideFromAddress"),{types:["geocode"]});n=new google.maps.places.Autocomplete(document.getElementById("editRideToAddress"),{types:["geocode"]});n=new google.maps.places.Autocomplete(document.getElementById("editRideViaLocation"),{types:["geocode"]});google.maps.event.addListener(n,"place_changed",function(){});$("#editRideStartToLocation,#editRideToLocation").keyup(function(e){r()});$(".add-on").on("click",function(e){$("#editRideTime").timepicker("show")});$(document).on("click",".showLift",function(){var e=JSON.parse($.session.get("liftData"));loadLiftsAssigned(e[$(this).attr("for")]);return false});$(document).on("change","#editRideStartLocation,#editRideFromAddress,#editRideToAddress,#editRideToStartLocation",function(){setTimeout(function(){getCountribution()},300);return false});$("#editRideToAddress,#editRideFromAddress").on("keyup",function(e){if(e.keyCode==13){$(this).blur()}if($(this).val().trim()==""){$("#editRidePriceSlider").slider("option","disabled",true);$("#editRidePriceSlider").slider("value",0);$("#maxPrice").text("$");$("#editRidePriceRange").text("$")}});$(document).on("click",".editRide",function(){$.session.set("rideId",$(this).attr("for"));$.session.set("ownerId",$(this).attr("ownerId"));$.session.set("entityId",$(this).attr("entityId"));$.session.set("customerId",$(this).attr("customerId"));$.session.set("status",$(this).attr("status"));var e=JSON.parse($.session.get("liftData"));loadRideInfo(e[$(this).attr("for")]);moveTotop();$("#editRideModal").modal("show");return false});$(document).on("click",".exchange",function(){$("#startEditRideSelect,#startEditRideInput,#toEditRideInput,#toEditRideSelect").toggleClass("hide");$("#editRideStartLocation,#editRideFromAddress,#editRideToAddress,#editRideToStartLocation").toggleClass("isShown");$("#startEditRideInput #editRideFromAddress,#toEditRideInput #editRideToAddress").toggleClass("ignore");var n=$("#editRideStartLocation option:selected").val();var r=$("#editRideFromAddress").val();var i=$("#editRideToAddress").val();var s=$("#editRideToStartLocation option:selected").val();$("#editRideToStartLocation").select2("val",n);$("#editRideFromAddress").val(i);$("#editRideToAddress").val(r);$("#editRideStartLocation ").select2("val",s);if(!$("#editRideFromAddress").hasClass("ignore")){$("#startLabel").html("Address");$("#toLabel").html("Airport");e=$("option:selected","#editRideToStartLocation").val();t=$("#editRideFromAddress").val()}else{$("#startLabel").html("Airport");$("#toLabel").html("Address");e=$("option:selected","#editRideStartLocation").val();t=$("#editRideToAddress").val()}return false});$("#editRideDateTime").datePicker();$("#editRideTime").timePicker();$("#editRideTime").on("click",function(){$(this).next(".popover").remove();$(this).popover("hide")});$(".icon-calendar").on("click",function(){$(this).closest("div").children('input[type="text"]').$("#editRideDateTime").datePicker("show");return false});$(document).on("click",".deleteRide",function(){var e=$(this).attr("for");var t=$(this).attr("entityId");bootbox.confirm("Do you want to delete this record ?",function(n){if(n){var r=deleteItem(t);if(r){deleteRide(e)}}});return false});$("#editRideBags").on("click",function(){$("#bagSizeDiv").slideToggle();return false});var i=$("#editRideForm").validate({ignore:":hidden .ignore",focusInvalid:false,focusCleanup:true,onfocusout:function(e){if(!$(e).is("select")&&e.value===""&&e.defaultValue===""){$(e).valid()}if($(e).valid()){$(e).removeClass("error").addClass("success")}else{$(e).removeClass("success").addClass("error")}},showErrors:function(e,t){$.each(this.successList,function(e,t){return $(t).popover("hide")});return $.each(t,function(e,t){getErrorPopupTemplate(t,"top")})},rules:{editRideDateTime:{required:true,date:false},editRideTime:{required:true,date:false},editRideToAddress:{required:true},editRideSeat:{required:true},editRideFromAddress:{required:true}},messages:{editRideDateTime:{required:VALIDATION_ERROR_MSG_SELECT.replace("{element}","date")},editRideTime:{required:VALIDATION_ERROR_MSG_SELECT.replace("{element}","time")},editRideToAddress:{required:VALIDATION_ERROR_MSG_INPUT.replace("{element}","drop off")},editRideFromAddress:{required:VALIDATION_ERROR_MSG_INPUT.replace("{element}","pick up")},editRideSeat:{required:VALIDATION_ERROR_MSG_INPUT.replace("{element}","seat required")}},invalidHandler:function(e,t){if(t.numberOfInvalids()){return false}},submitHandler:function(e){$("#editRideLoader").removeClass("hide");$("#updateRide").attr("disabled","disabled");updateRide()}}).settings});$(window).bind("beforeunload",function(){if($("#myRidesContainer-nav-select").is(":visible")){var e=$("#myRidesContainer-nav-select option:selected").val().split("tab")[1];$.session.set("selectedTabMyBooking",e)}else{$("#myRidesContainer-nav-ul li").each(function(e){if($("a",this).hasClass("current")){var t=$("a",this).attr("href").split("#")[1];$.session.set("selectedTabMyBooking",t)}})}})