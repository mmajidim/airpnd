function getRides(){if($.session.get("dateFindRide")){$("#bookRideContainer").removeClass("hide");$("#errorContainer").addClass("hide");var e={action:GET_RIDES,location:JSON.stringify($.session.get("locationFindRide")),startType:JSON.stringify($.session.get("startType")),address:JSON.stringify($.session.get("addressFindRide")),date:JSON.stringify($.session.get("dateFindRide")),time:JSON.stringify($.getDateTime.time($.session.get("timeFindRide"),true)),seats:JSON.stringify($.session.get("seatsFindRide")),bags:JSON.stringify($.session.get("bagsFindRide")),bagSize:JSON.stringify($.session.get("bagSizeFindRide")),smoker:JSON.stringify($.session.get("smokerFindRide"))};$.ajax({type:"POST",url:CUSTOM_API_URL,data:e,dataType:"json",headers:HEADER,async:false,error:function(e){showAlertBox("Error",ERROR_MSG)},success:function(e){$.session.set("ridesData",JSON.stringify(e));loadRidesContainer()}})}else{var t='<table class="table table-bordered"><tr>';t+="<th>First Name</th><th>Last Name</th><th>Pick Up</th>";t+="<th>Drop Off</th><th>Via</th><th>Smoker</th>";t+="<th>Within</th><th>Contribution</th></tr>";t+='<tr><td colspan="99"><center><b>No Records Found !';t+="</b></center></td></tr></table>";$("#riderResult").append(t)}}function loadRidesContainer(){loadMatchedRides("contribution",1)}function bookARide(e,t,n){var r=-1;var i={action:BOOK_A_RIDE,rideId:JSON.stringify(e),liftId:JSON.stringify(t),seats:JSON.stringify(n)};$.ajax({type:"POST",url:CUSTOM_API_URL,data:i,dataType:"json",headers:HEADER,async:false,error:function(e){showAlertBox("Error",ERROR_MSG)},success:function(e){r=e.retCode}});return r}function getDriverEmailBody(e,t,n){var r;var i='<a class="btnEmail" href="{0}confirmRider.php{1}">';i+="Click Here </a>";var s=String.format(i,SITE_URL,n);var r="<div><p><strong>Dear "+e+"</strong>,</p><br />";r+="<p>You have successfully book a rider.</p>";r+="<p>Please click on the link to confirm a rider.";r+="</p><p>"+s+"<br><br></p>";r+="<br /><p>Regards:-</p>";r+="<p>Airpnd Team.</p>";r+="<p><sub><i>This is a system generated";r+="&nbsp;mail. Please do not reply to it.";r+="</i><sub></p></div>";return r}function getRiderEmailBody(e,t){var n="<div><p><strong>Dear "+e+"</strong>,</p><br />";n+="<p>Your request has been sent to the driver.</p>";n+="<p><strong>Driver Details</strong></p>";n+='<table border="1px">';n+="<tr><td> Driver Name </td><td>"+t.name+"</td></tr>";n+="<tr><td> Driver Email </td><td>"+t.email+"</td></tr></table>";n+="<br /><p>Regards:-</p>";n+="<p>Airpnd Team.</p>";n+="<p><sub><i>This is a system generated";n+="&nbsp;mail. Please do not reply to it.";n+="</i><sub></p></div>";return n}function loadMatchedRides(e,t){$("#riderResult").empty();$("#riderResult").fadeOut("slow");var n="";var r=JSON.parse($.session.get("ridesData"));if(r.retCode&&r.rides.length>0){r=sortByKey(r.rides,e,t);var i=r[0].startType==AIRPORT_START?"Airport":"Address";var s=r[0].startType==ADDRESS_START?"Airport":"Address";n+='<table class="table table-bordered"><tr>';n+="<th>First Name</th><th>Last Name</th><th>"+i+"</th>";n+="<th>"+s+"</th><th>Via</th><th>Smoker</th>";n+="<th>Seats</th>";n+="<th>Datetime</th>";n+="<th>Within</th><th>Contribution</th><th>&nbsp;</th></tr>";$.each(r,function(e,t){var r=t.smoker?"Yes":"No";var i=t.via==null?"NA":t.via;var s=$.getDateTime.datePickerDateTime(t.datetime);var o=$.session.get("seatsFindRide")>=t.seats?t.seats:$.session.get("seatsFindRide");n+="<tr><td>"+t.firstName+"</td>";n+="<td>"+t.lastName.substring(0,1)+"..."+"</td>";n+="<td>"+t.start+"</td>";n+="<td>"+t.to+"</td>";n+="<td>"+i+"</td>";n+="<td>"+r+"</td>";n+="<td>"+t.seats+"</td>";n+="<td>"+s+"</td>";n+="<td>"+t.maxMiles+" Miles</td>";n+="<td>$"+t.contribution.toFixed(2)+"</td>";n+='<td><a href="#" ownerId="'+t.ownerId+'" rideId="';n+=t.rId+'" entityId ="'+t.entityId;n+='" class="select btn btn-default" seats="';n+=o+'"> ';n+="Confirm </a></td></tr>"});n+="</table>"}else{$("#filterBy").hide();$("#sortBy").hide();n+='<table class="table table-bordered"><tr>';n+="<th>First Name</th><th>Last Name</th><th>Pick Up</th>";n+="<th>Drop Off</th><th>Via</th><th>Smoker</th>";n+="<th>Within</th><th>Contribution</th></tr>";n+='<tr><td colspan="99"><center>No Records Found !';n+="</center></td></tr></table>"}$("#riderResult").append(n);$("#riderResult").fadeIn("slow");setTimeout(function(){getPopUp(".select","#popUpContainer","right")},100)}function loadCustomerLifts(){var e=$("#myFindRideContainer").children().length==0;if(e){var t=sessionManager("getSession","customerId");var n=liftsByCustomer(t);var r="";var i=n.lifts==null||n.lifts.length==1;if(n.retCode&&n.lifts.length>0){n=sortByKey(n.lifts,"dt","0");$.each(n,function(e,t){var n=t.status!=3;var i=$.getDateTime.formatDateTime(t.dt);var s=$.getDateTime.formatDate(t.dt);r+='<div><h2 class="title greenLabel">'+s+"</h2>";r+='<table class="table table-striped">';if(n){r+='<tr><td width="105">';r+='<a href="#" class="selectRider"';r+=' liftId="'+t.id+'" date="'+t.dt+'"';r+=' customerId="'+t.customerId+'"><i class="icon-th"></i>';r+=" Select Lift</a></td></tr>"}r+='<tr><td>Date</td><td class="date">'+i+"</td></tr>";r+="</td></tr>";r+='<tr><td>From</td><td class="start">'+t.start+"</td></tr>";r+='<tr><td>To</td><td class="to">'+t.to+"</td></tr>";r+='<tr><td>Seats</td><td class="seat">'+(t.seats||"-")+"</td></tr>";r+="<tr><td>Status</td><td>"+getLiftStatusName(t.status)+"</td></tr>";r+="<tr><td>Note</td>";r+='<td class="textBreak">'+(t.note||"-");r+="</td></tr>";r+="</table></div>"})}else{r+='<div><h2 class="greenLabel">';r+="No lift is found.</h2></div>"}$("#myFindRideContainer").append(r)}$("#modalFade").removeClass("hide");$("#panelMyRide").removeClass("hide");if(e){$("#myFindRideContainer").contentSlider("My Lifts",i,$.session.get("selectedTabBookRide"))}}function getLiftStatusName(e){var t="";switch(e){case"0":t="New Lift";break;case"1":t="Pending Confirm";break;case"2":t="Pending Payment";break;case"3":t="Fulfilled";break}return t}$(function(){getRides();$("#filterOrder").on("change",function(){loadMatchedRides($("#filterPrice option:selected").val(),$("option:selected",this).val())});$("#filterPrice").on("change",function(){loadMatchedRides($("option:selected",this).val(),$("#filterOrder option:selected").val())});$(document).on("click",".selectRider",function(e){$.session.set("liftId",$(this).attr("liftId"));$("#modalFade").addClass("hide");$("#panelMyRide").addClass("hide");$.session.set("hasLift",true);e.preventDefault()});$(document).on("click",".close",function(){$("#modalFade").addClass("hide");$("#panelMyRide").addClass("hide")});$(document).on("click",".select",function(e){$.session.set("rideId",$(this).attr("rideId"));$.session.set("seats",$(this).attr("seats"));$.session.set("ownerId",$(this).attr("ownerId"));var t=sessionManager("getSession","customerId");if(t){if(!$.session.get("hasLift")){loadCustomerLifts()}else{$(this).popover("show");$(".select").not(this).popover("hide")}}else{loadSignInModal()}return false});$(document).on("click",".closePopUp",function(e){$(this).closest(".popover").removeClass("in");return false});$(document).on("click","#sendSMS",function(e){$("#sendSmsLoader").removeClass("hide");$("#sendSMS").attr("disabled","disabled");window.setTimeout(function(){var e=getOwnerByOwnerId($.session.get("ownerId"),true);var t=$("response returnVal phone1",e).text();var n=$("response returnVal email",e).text();var r=$("response returnVal firstName",e).text()+" "+$("response returnVal lastName",e).text();t=t.split("-").join("");var i=$.session.get("liftId")+";"+$.session.get("rideId")+";"+$.session.get("seats");var s=getLink(i);var o=$("#messageContent").val()+"\n"+" "+SITE_URL+"confirmRider.php"+s;var u=sendTextMessage(t,o);var a=getDriverEmailBody(r,n,s);var f=sessionManager("getSession","customerId");var l=getCustomerByCustomerId(f,true);var c=$("response firstName",l).text()+" "+$("response lastName",l).text();var h={name:r,email:n};var p=getRiderEmailBody(c,h);var d=sendEmail(n,"Confirm a Ride ",a);d=sendEmail($("response email",l).text(),"Acknowledgment for Booking a Ride",p);if(u||d){u=bookARide($.session.get("rideId"),$.session.get("liftId"),$.session.get("seats"));if(u){u=pendingConfirmLift($.session.get("liftId"));if(u){var v="A lift confirmation link has been sent ";v+=" to the driver contact number and";v+=" email address.";$.session.clear("hasLift");$.session.clear("liftId");showAlertBox("Confirm Alert",v,SITE_URL+"findRide.php")}}else{showAlertBox("Error",ERROR_MSG)}}return false},100)})});$(window).on("load",function(){$("#filterOrder").select2();$("#filterPrice").select2();loadMatchedRides($("#filterPrice option:selected").val(),$("option:selected","#filterOrder").val())});$(window).bind("beforeunload",function(){if($("#myFindRideContainer-nav-select").is(":visible")){var e=$("#myFindRideContainer-nav-select option:selected").val().split("tab")[1];$.session.set("selectedTabBookRide",e)}else{$("#myFindRideContainer-nav-ul li").each(function(e,t){if($("a",this).hasClass("current")){var n=$("a",this).attr("href").split("#")[1];$.session.set("selectedTabBookRide",n)}})}})